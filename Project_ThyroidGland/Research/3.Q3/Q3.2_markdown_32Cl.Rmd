---
title: "Q3.2_markdown"
author: "Thomas De Deyn"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo = FALSE}

library(tidyverse)
library(fgsea)
library(RColorBrewer)
library(data.table)

```

# BINF-F401 project (R Markdown)

The task assigned was to study the RNA expression of a set of patients. First, let's set the parameters used throughout the scripts.

```{r}
  p_value = .05
  discrete = 20
  minSize = 5
```

## Morphology vs Reactome

### 1. Report:

-   The number of significant down-regulated and up-regulated genes associated with each morphological cluster
-   The 10 most significant up-regulated genes

```{r, echo = FALSE}
morphological_counts = read_tsv("D:/Polytech/MA2 2023-2024/Q2/Genomics/Project_ThyroidGland/Data_ThyroidGland/OG/morphological_counts_lunit_dino.tsv")
coldata = morphological_counts
RNA_read = read_tsv("D:/Polytech/MA2 2023-2024/Q2/Genomics/Project_ThyroidGland/Data_ThyroidGland/OG/RNA_read_counts.tsv")
reactome = gmtPathways("D:/Polytech/MA2 2023-2024/Q2/Genomics/Project_ThyroidGland/Data_ThyroidGland/OG/c2.cp.reactome.v7.5.1.symbols.gmt")

clinical = read_tsv("D:/Polytech/MA2 2023-2024/Q2/Genomics/Project_ThyroidGland/Data_ThyroidGland/OG/clinical_data.tsv")
coldata = coldata %>% left_join(by = "SMPLID", y = clinical)

```

### -----------------------------------------------------------------------------------------------------

### Step 1: Exporting the ranks required by fgsea

```{r, echo = FALSE}

matrix_to_list <- function(pws){
  pws.l <- list()
  for (pw in colnames(pws)) {
    pws.l[[pw]] <- rownames(pws)[as.logical(pws[, pw])]
  }
  return(pws.l)
}
  
prepare_gmt = function(gmt, genes_in_data, savefile = FALSE){
  hidden = unique(unlist(gmt))
  
  mat = matrix(NA, dimnames = list(hidden, names(gmt)), 
               nrow = length(hidden), ncol = length(gmt))
  for (i in 1:dim(mat)[2]){
    mat[,i] = as.numeric(hidden %in% gmt[[i]])
  }
  # Subset to the genes that are present in the DESEQ results
  hidden1 = intersect(genes_in_data, hidden)
  # Select pathways with at least 5 genes
  mat = mat[hidden1, colnames(mat)[which(colSums(mat[hidden1,]) > minSize )]]
  
  final_list = matrix_to_list(mat)
  
  print(".gmt successfully prepared")
  return(final_list)
}


fgseaRes = c()

print('Starting....')
print(Sys.time())

for (var in names(res)[]){
  print(paste(var, ", ", which(names(res) == var), "/", length(names(res))))
  
### Step 1: Exporting the ranks required by fgsea

result_ofCluster = res[[var]]

#remove NA: 
NAs = apply(is.na(result_ofCluster), 1, any)
if(length(which(NAs)) != 0){
 result_ofCluster = result_ofCluster[!is.na(result_ofCluster$padj),]
}

result_ofCluster = result_ofCluster[order(result_ofCluster$log2FoldChange, decreasing = TRUE),]
result_ofCluster = result_ofCluster[ (result_ofCluster$padj < p_value) ,]
result_ofCluster = result_ofCluster[ (result_ofCluster$log2FoldChange > 0) ,]

### Step 2: Replace names

RNA_kept = RNA_read[RNA_read$Name %in% rownames(result_ofCluster),]

result_ofCluster = result_ofCluster[ (result_ofCluster$log2FoldChange > 0) ,]
# Find matching names with gene ID
Genes_indices = match(rownames(result_ofCluster), RNA_kept$Name)

# Replace gene ID by gene name. 
Genes_ofCluster = result_ofCluster
Genes_ofCluster$gene_code = rownames(Genes_ofCluster)
rownames(Genes_ofCluster)[Genes_indices] = RNA_kept$Description[Genes_indices]
Genes_ofCluster$gene_symbol = rownames(Genes_ofCluster)
    

### Step 3: Filter genes file
# https://www.youtube.com/watch?v=itaZcIXZAwg&ab_channel=Biostatsquid

#"Gene Set Enrichment Analysis (GSEA) with fgsea - easy R tutorial" YouTube, uploaded by Biostatsquid, 10 September 2023 


pathways = prepare_gmt(reactome, Genes_ofCluster$gene_symbol)


### Step 4: Prepare ranking list

ranking = Genes_ofCluster$log2FoldChange
names(ranking) = rownames(Genes_ofCluster)


# Idea: replace inf values with finite. Safety not useful for us
max_rk = max(ranking[is.finite(ranking)])
min_rk = min(ranking[is.finite(ranking)])

ranking = replace(ranking, ranking > max_rk, max_rk *10)
ranking = replace(ranking, ranking < min_rk, min_rk *10)

tmp = fgsea(pathways = pathways, 
                 stats = ranking, 
                 scoreType = 'pos', 
                 minSize = minSize,
                 maxSize = 500, 
                 nproc = 1)

fgseaRes[var] = list(tmp)

  data <- data.frame(tmp)

# Convert the data frame to a string format for the file
  data_str <- apply(data, 1, function(row) paste(row, collapse = "\t"))
  data_str <- paste(data_str, collapse = "\n")
path_out = "D:/Polytech/MA2 2023-2024/Q2/Genomics/Project_ThyroidGland/Result/3.2.reactome/"

cat("-------------------------------\n",
    " Cluster: \t",var, "\n",
    "-------------------------------\n",
    "Number of up-regulated genes:\t", sum(tmp$padj < 0.05 & tmp$NES > 0), "\n",
    "Number of down-regulated genes:\t", sum(tmp$padj < 0.05 & tmp$NES < 0), "\n",
    "-------------------------------\n",
    
    paste(colnames(data), collapse = "\t"), "\n", 
    paste(data_str, collapse = "\n"),
    file = paste0(path_out, var, '.txt', sep ="" ) )

  ggplot(tmp, aes(tmp$pathway, tmp$NES)) +
  geom_col(aes(fill=tmp$padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title=paste0("Hallmark pathways NES from GSEA \n (", var,")", sep ="" )) + 
  theme_minimal()
  ggsave(paste0(path_out, var, '_NonAdjusted.pdf', sep ="" ))

  ggplot(tmp, aes(tmp$pathway, tmp$NES)) +
  geom_col(aes(fill=tmp$padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title=paste0("Hallmark pathways NES from GSEA \n (", var,")", sep ="" )) + 
  theme_minimal()
  ggsave(paste0(path_out, var, '_Adjusted.pdf', sep ="" ))

  ggplot(tmp, aes(x = pathway, y = NES, fill = padj)) +
  geom_col() +
  coord_flip() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.05, limits = c(0, 1), name = "padj") +
  labs(x = "Pathway", y = "Normalized Enrichment Score",
       title = paste0("Hallmark pathways NES from GSEA \n (", var,")")) +
  theme_minimal()
  ggsave(paste0(path_out, var, '_continuous.pdf', sep ="" ))
  
  ########
    ggplot(tmp, aes(tmp$pathway, tmp$NES)) +
  geom_col(aes(fill=tmp$padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title=paste0("Hallmark pathways NES from GSEA \n (", var,")", sep ="" )) + 
  theme_minimal()
  ggsave(paste0(path_out,'/PNG/', var, '_NonAdjusted.png', sep ="" ))

  ggplot(tmp, aes(tmp$pathway, tmp$NES)) +
  geom_col(aes(fill=tmp$padj<0.05)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title=paste0("Hallmark pathways NES from GSEA \n (", var,")", sep ="" )) + 
  theme_minimal()
  ggsave(paste0(path_out,'/PNG/', var, '_Adjusted.png', sep ="" ))

  ggplot(tmp, aes(x = pathway, y = NES, fill = padj)) +
  geom_col() +
  coord_flip() +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0.05, limits = c(0, 1), name = "padj") +
  labs(x = "Pathway", y = "Normalized Enrichment Score",
       title = paste0("Hallmark pathways NES from GSEA \n (", var,")")) +
  theme_minimal()
  ggsave(paste0(path_out,'/PNG/', var, '_continuous.png', sep ="" ))

}

print('Finished....')
print(Sys.time())
```



### Step 6: display results

```{r, echo = FALSE}

var = names(res)[1]
A = fgseaRes[var]

View(head(A[order(pval),]))

sum(A[,padj < p_value])
sum(A[,pval < p_value])

```